<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>All Subscriptions - Admin</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
body {
    background: linear-gradient(rgba(0,0,0,0.85), rgba(0,0,0,0.85)), url('images/background.jpg');
    background-size: cover;
    background-position: center;
    min-height: 100vh;
    color: #fff;
    font-family: 'Segoe UI', sans-serif;
}
.sidebar { background: rgba(255,255,255,0.05); min-height:100vh; padding:20px; }
.nav-link { color:#ddd !important; }
.nav-link:hover { color:#fff !important; }
.table thead th { color: #fff; }
.table tbody td { color: #ccc; vertical-align: middle; }
.status-badge {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: bold;
    display: inline-block;
}
.status-active { background-color: #28a745; }
.status-paused { background-color: #ffc107; color: #000; }
.status-expired { background-color: #dc3545; }
.btn-gradient { 
    background: linear-gradient(to right, #270D7D, #281A84, #2C4FA0, #2D5CA7); 
    color:#fff; border:none; padding:5px 12px; border-radius:6px; font-weight:bold; 
}
.btn-gradient:hover { 
    background: linear-gradient(to right, #2D5CA7, #2C4FA0, #281A84, #270D7D); 
}
</style>
</head>
<body>

<div class="container-fluid">
<div class="row">

<!-- Sidebar -->
<div class="col-lg-2 sidebar">
<h4 style="text-align:center;">Menu</h4>
<nav class="nav flex-column">
    <a class="nav-link" href="./AdminDashboard.html"><i class="fa fa-home"></i> Dashboard</a>
    <a class="nav-link" href="./AllUsers.html"><i class="fa fa-users"></i> All Users</a>
    <a class="nav-link active" href="#"><i class="fa fa-list"></i> All Subscriptions</a>
    <a class="nav-link" href="./ManageSubscriptions.html"><i class="fa fa-user"></i> Manage Plans</a>
</nav>
</div>

<!-- Main Content -->
<div class="col-12 col-lg-10 p-4">
<h2>All Subscriptions with Plan Details</h2>

<table class="table table-dark table-striped mt-4">
    <thead>
        <tr>
            <th>Sub ID</th>
            <th>User Email</th>
            <th>Plan Name</th>
            <th>Description</th>
            <th>Price</th>
            <th>Activity</th>
            <th>Start Date</th>
            <th>Expiry Date</th>
            <th>Status</th>
        </tr>
    </thead>
    <tbody id="subsTableBody">
        <!-- Subscriptions will be injected here -->
    </tbody>
</table>
</div>
</div>
</div>

<script>
const user = JSON.parse(localStorage.getItem('user'));
if(!user || user.role.toLowerCase() !== "admin") {
    window.location.href = 'Login.html';
}

async function loadSubscriptions() {
    try {
        // Fetch subscriptions joined with plan details from your backend
        const res = await fetch('http://localhost:3000/api/subscriptions-with-plans');
        const subs = await res.json();
        const tbody = document.getElementById('subsTableBody');
        tbody.innerHTML = '';

        const today = new Date();

        subs.forEach(s => {
            const tr = document.createElement('tr');

            // Determine status based on activity and expiry date
            const expiryDate = new Date(s.expiryDate);
            let statusText = 'Active';
            let statusClass = 'status-active';
            if(s.activity === 'Paused') {
                statusText = 'Paused';
                statusClass = 'status-paused';
            } else if(expiryDate < today) {
                statusText = 'Expired';
                statusClass = 'status-expired';
            }

            tr.innerHTML = `
                <td>${s.id}</td>
                <td>${s.userEmail}</td>
                <td>${s.name}</td>
                <td>${s.description}</td>
                <td>â‚¹${s.price}</td>
                <td>${s.activity}</td>
                <td>${new Date(s.startDate).toLocaleDateString()}</td>
                <td>${expiryDate.toLocaleDateString()}</td>
                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
            `;
            tbody.appendChild(tr);
        });

    } catch(err) {
        console.error("Error loading subscriptions:", err);
    }
}

loadSubscriptions();
</script>

</body>
</html>
